#!/usr/bin/env python3
# typescope.py
# TypeScope - local-only, consent-first keystroke capture demo (Tkinter GUI)

import argparse
import getpass
import json
import threading
import time
from datetime import datetime
from pathlib import Path
from typing import Optional

import tkinter as tk
from tkinter.scrolledtext import ScrolledText
from rich.console import Console
from logger_utils import derive_key_from_password, encrypt_bytes

console = Console()

# Files & directories
LOGFILE = Path("keystrokes.jsonl")
ROTATED_DIR = Path("rotated_logs")
ROTATED_DIR.mkdir(exist_ok=True)

class TypeScopeApp:
    def __init__(self, root, encrypt: bool=False, password: Optional[str]=None, rotate_size: int=1024*100):
            """
                    :param root: Tk root
                            :param encrypt: whether to encrypt logs on disk
                                    :param password: passphrase for encryption; required if encrypt True
                                            :param rotate_size: rotate when file reaches this number of bytes
                                                    """
                                                            self.root = root
                                                                    self.encrypt = encrypt
                                                                            self.rotate_size = rotate_size
                                                                                    self.password = password
                                                                                            self.key = None
                                                                                                    if self.encrypt:
                                                                                                                if not self.password:
                                                                                                                                raise ValueError("Encrypt enabled but no password provided")
                                                                                                                                            self.key = derive_key_from_password(self.password)

                                                                                                                                                    root.title("TypeScope â€” Local-only Consent Demo")
                                                                                                                                                            self.logging = False
                                                                                                                                                                    self._setup_ui()
                                                                                                                                                                            self._start_background_rotate_check()

                                                                                                                                                                                def _setup_ui(self):
                                                                                                                                                                                        top_frame = tk.Frame(self.root)
                                                                                                                                                                                                top_frame.pack(fill="x", padx=8, pady=6)

                                                                                                                                                                                                        self.toggle_btn = tk.Button(top_frame, text="Start Logging", command=self.toggle_logging, width=14)
                                                                                                                                                                                                                self.toggle_btn.pack(side="left")

                                                                                                                                                                                                                        self.save_var = tk.BooleanVar(value=True)
                                                                                                                                                                                                                                self.save_chk = tk.Checkbutton(top_frame, text="Save to file", variable=self.save_var)
                                                                                                                                                                                                                                        self.save_chk.pack(side="left", padx=8)

                                                                                                                                                                                                                                                rotate_label = tk.Label(top_frame, text=" Rotate size (bytes):")
                                                                                                                                                                                                                                                        rotate_label.pack(side="left", padx=(12,0))
                                                                                                                                                                                                                                                                self.rotate_entry = tk.Entry(top_frame, width=10)
                                                                                                                                                                                                                                                                        self.rotate_entry.insert(0, str(self.rotate_size))
                                                                                                                                                                                                                                                                                self.rotate_entry.pack(side="left", padx=(0,6))

                                                                                                                                                                                                                                                                                        self.rotate_btn = tk.Button(top_frame, text="Rotate Now", command=self.rotate_now)
                                                                                                                                                                                                                                                                                                self.rotate_btn.pack(side="right")

                                                                                                                                                                                                                                                                                                        self.clear_btn = tk.Button(top_frame, text="Clear Log File", command=self.clear_logfile)
                                                                                                                                                                                                                                                                                                                self.clear_btn.pack(side="right", padx=6)

                                                                                                                                                                                                                                                                                                                        self.info_label = tk.Label(self.root, text="Type in the box below. Only keystrokes inside this window are captured when logging is ON.")
                                                                                                                                                                                                                                                                                                                                self.info_label.pack(anchor="w", padx=8)

                                                                                                                                                                                                                                                                                                                                        self.text = ScrolledText(self.root, width=100, height=20)
                                                                                                                                                                                                                                                                                                                                                self.text.pack(padx=8, pady=6)
                                                                                                                                                                                                                                                                                                                                                        # Bind Key event to the text widget only (no global hooks)
                                                                                                                                                                                                                                                                                                                                                                self.text.bind("<Key>", self.on_key)

                                                                                                                                                                                                                                                                                                                                                                        self.events_display = ScrolledText(self.root, width=100, height=8, state="disabled")
                                                                                                                                                                                                                                                                                                                                                                                self.events_display.pack(padx=8, pady=(0,8))

                                                                                                                                                                                                                                                                                                                                                                                        bottom = tk.Frame(self.root)
                                                                                                                                                                                                                                                                                                                                                                                                bottom.pack(fill="x", padx=8, pady=(0,8))
                                                                                                                                                                                                                                                                                                                                                                                                        self.status_label = tk.Label(bottom, text="Idle")
                                                                                                                                                                                                                                                                                                                                                                                                                self.status_label.pack(anchor="w")

                                                                                                                                                                                                                                                                                                                                                                                                                    def _start_background_rotate_check(self):
                                                                                                                                                                                                                                                                                                                                                                                                                            def bg():
                                                                                                                                                                                                                                                                                                                                                                                                                                        while True:
                                                                                                                                                                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # update rotate_size from entry if user changed it
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        val = int(self.rotate_entry.get().strip())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if val > 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.rotate_size = val
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                except Exception:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        pass
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self._maybe_rotate()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                pass
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                time.sleep(2)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        t = threading.Thread(target=bg, daemon=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                t.start()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def toggle_logging(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.logging = not self.logging
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.toggle_btn.config(text="Stop Logging" if self.logging else "Start Logging")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self._append_event({"event":"logging_toggled","value":self.logging})
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.status_label.config(text="Logging" if self.logging else "Idle")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def on_key(self, event):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        handler bound to the app's text widget. Only captures keys typed into this widget.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if not self.logging:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            entry = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "timestamp": datetime.utcnow().isoformat() + "Z",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "event": "key",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "keysym": event.keysym,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "char": event.char,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "state": event.state
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self._append_event(entry)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def _append_event(self, entry: dict):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # show in events pane
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            text = f"{entry['timestamp']}  {entry.get('event')}  {entry.get('keysym','')}  {repr(entry.get('char',''))}\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.events_display.configure(state="normal")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.events_display.insert("1.0", text)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.events_display.configure(state="disabled")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # save to file if enabled
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if self.save_var.get():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self._write_log(entry)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def _write_log(self, entry: dict):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            data = json.dumps(entry, ensure_ascii=False)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if self.encrypt and self.key:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                blob = encrypt_bytes(self.key, data.encode("utf-8"))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                line = blob.decode("utf-8") + "\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            console.print("[red]Encryption failed:[/red]", e)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                line = data + "\n"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        with LOGFILE.open("a", encoding="utf-8") as f:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    f.write(line)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # update status
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.status_label.config(text=f"Saved @ {datetime.utcnow().strftime('%H:%M:%S')}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def _maybe_rotate(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if LOGFILE.exists() and LOGFILE.stat().st_size >= self.rotate_size:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ts = datetime.utcnow().strftime("%Y%m%dT%H%M%SZ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            dest = ROTATED_DIR / f"keystrokes_{ts}.jsonl"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            LOGFILE.replace(dest)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            console.print(f"[yellow]Rotated log to {dest}[/yellow]")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # clear status after rotate
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.status_label.config(text=f"Rotated @ {datetime.utcnow().strftime('%H:%M:%S')}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                console.print("[red]Rotate error:[/red]", e)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def rotate_now(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if LOGFILE.exists():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ts = datetime.utcnow().strftime("%Y%m%dT%H%M%SZ")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    dest = ROTATED_DIR / f"keystrokes_manual_{ts}.jsonl"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                LOGFILE.replace(dest)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            console.print(f"[green]Manual rotate: {dest}[/green]")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.status_label.config(text=f"Manual rotate done")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def clear_logfile(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if LOGFILE.exists():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                LOGFILE.unlink()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.events_display.configure(state="normal")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.events_display.delete("1.0", "end")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.events_display.configure(state="disabled")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                console.print("[green]Cleared log file and UI display[/green]")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.status_label.config(text="Idle")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def parse_args():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            p = argparse.ArgumentParser(prog="TypeScope (local-only)")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                p.add_argument("--encrypt", action="store_true", help="Encrypt logs on disk with AES-GCM (prompt for passphrase)")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    p.add_argument("--rotate-size", type=int, default=1024*100, help="Rotate size bytes (default 100KB)")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return p.parse_args()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def run_app():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            args = parse_args()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                password = None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if args.encrypt:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            password = getpass.getpass("Enter encryption passphrase (will not be stored): ").strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if not password:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("Encryption passphrase required when --encrypt is used.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                root = tk.Tk()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    app = TypeScopeApp(root, encrypt=args.encrypt, password=password, rotate_size=args.rotate_size)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        root.mainloop()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            run_app()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            